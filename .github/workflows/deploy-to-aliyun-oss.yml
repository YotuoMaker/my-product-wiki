name: Deploy to Aliyun OSS

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install mkdocs-material mkdocs-video

      - name: Build site
        run: mkdocs build --clean

      - name: Upload to OSS
        env:
          ENDPOINT: oss-cn-beijing.aliyuncs.com
          BUCKET: my-product-wiki
          ACCESS_KEY_ID: ${{ secrets.ALIYUN_OSS_KEY_ID }}
          ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_OSS_KEY_SECRET }}
        run: |
          wget https://gosspublic.alicdn.com/ossutil/1.7.17/ossutil64
          chmod +x ossutil64
          ./ossutil64 config -e $ENDPOINT -i $ACCESS_KEY_ID -k $ACCESS_KEY_SECRET
          ./ossutil64 cp -r site/ oss://$BUCKET/ --recursive --force
          echo "部署成功！访问：https://$BUCKET.$ENDPOINT"
